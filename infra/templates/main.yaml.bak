AWSTemplateFormatVersion: '2010-09-09'
Description: 'Pipeline de Datos Serverless - Stack Principal - AWS Academy'

Parameters:
  LabRoleArn:
    Type: String
    Description: ARN del rol LabRole preasignado
    
  S3BucketRaw:
    Type: String
    Description: Nombre del bucket S3 para archivos raw
    
  S3BucketLogs:
    Type: String
    Description: Nombre del bucket S3 para logs de la aplicación
    
  DDBTableName:
    Type: String
    Description: Nombre de la tabla DynamoDB
    Default: datasets-catalog
    
  LambdaMemorySize:
    Type: Number
    Description: Tamaño de memoria para funciones Lambda (MB)
    Default: 1024
    MinValue: 128
    MaxValue: 3008
    
  LambdaTimeout:
    Type: Number
    Description: Timeout para funciones Lambda (segundos)
    Default: 300
    MinValue: 3
    MaxValue: 900
    
  VpcCidr:
    Type: String
    Description: CIDR block para la VPC
    Default: 10.0.0.0/16
    
  PublicSubnetCidr:
    Type: String
    Description: CIDR block para la subred pública
    Default: 10.0.1.0/24
    
  PrivateSubnetCidr:
    Type: String
    Description: CIDR block para la subred privada
    Default: 10.0.2.0/24

Resources:
  # Network Stack
  NetworkStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://data-pipeline-templates-899325643341.s3.us-east-1.amazonaws.com/templates/network.yaml
      Parameters:
        VpcCidr: !Ref VpcCidr
        PublicSubnetCidr: !Ref PublicSubnetCidr
        PrivateSubnetCidr: !Ref PrivateSubnetCidr
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-Network
        - Key: Project
          Value: data-pipeline

  # Storage Stack
  StorageStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: NetworkStack
    Properties:
      TemplateURL: https://data-pipeline-templates-899325643341.s3.us-east-1.amazonaws.com/templates/storage.yaml
      Parameters:
        S3BucketRaw: !Ref S3BucketRaw
        S3BucketLogs: !Ref S3BucketLogs
        DDBTableName: !Ref DDBTableName
        LabRoleArn: !Ref LabRoleArn
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-Storage
        - Key: Project
          Value: data-pipeline

  # Lambda Stack
  LambdaStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: 
      - NetworkStack
      - StorageStack
    Properties:
      TemplateURL: https://data-pipeline-templates-899325643341.s3.us-east-1.amazonaws.com/templates/lambda.yaml
      Parameters:
        LabRoleArn: !Ref LabRoleArn
        LambdaMemorySize: !Ref LambdaMemorySize
        LambdaTimeout: !Ref LambdaTimeout
        S3BucketRawName: !GetAtt StorageStack.Outputs.S3BucketRawName
        DynamoDBTableName: !GetAtt StorageStack.Outputs.DynamoDBTableName
        S3BucketCodeName: !Sub "${AWS::AccountId}-lambda-code-${AWS::Region}"
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-Lambda
        - Key: Project
          Value: data-pipeline

  # Web Application Stack
  WebAppStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: 
      - NetworkStack
      - StorageStack
      - LambdaStack
    Properties:
      TemplateURL: https://data-pipeline-templates-899325643341.s3.us-east-1.amazonaws.com/templates/webapp.yaml
      Parameters:
        LabRoleArn: !Ref LabRoleArn
        VPCId: !GetAtt NetworkStack.Outputs.VPCId
        PublicSubnetId: !GetAtt NetworkStack.Outputs.PublicSubnetId
        InstanceType: t3.medium
        S3BucketRaw: !GetAtt StorageStack.Outputs.S3BucketRawName
        S3BucketLogs: !GetAtt StorageStack.Outputs.S3BucketLogsName
        DDBTableName: !GetAtt StorageStack.Outputs.DynamoDBTableName
        LambdaQueryFunctionName: !GetAtt LambdaStack.Outputs.LambdaQueryFunctionName
        LambdaETLFunctionName: !GetAtt LambdaStack.Outputs.LambdaETLFunctionName
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-WebApp
        - Key: Project
          Value: data-pipeline

Outputs:
  # Network Outputs
  VPCId:
    Description: ID de la VPC creada
    Value: !GetAtt NetworkStack.Outputs.VPCId
    Export:
      Name: !Sub ${AWS::StackName}-VPC-ID

  PublicSubnetId:
    Description: ID de la subred pública
    Value: !GetAtt NetworkStack.Outputs.PublicSubnetId
    Export:
      Name: !Sub ${AWS::StackName}-Public-Subnet-ID

  # Storage Outputs
  S3BucketRawName:
    Description: Nombre del bucket S3 para archivos raw
    Value: !GetAtt StorageStack.Outputs.S3BucketRawName
    Export:
      Name: !Sub ${AWS::StackName}-S3-Raw-Bucket

  S3BucketLogsName:
    Description: Nombre del bucket S3 para logs
    Value: !GetAtt StorageStack.Outputs.S3BucketLogsName
    Export:
      Name: !Sub ${AWS::StackName}-S3-Logs-Bucket

  DynamoDBTableName:
    Description: Nombre de la tabla DynamoDB
    Value: !GetAtt StorageStack.Outputs.DynamoDBTableName
    Export:
      Name: !Sub ${AWS::StackName}-DDB-Table

  DynamoDBTableArn:
    Description: ARN de la tabla DynamoDB
    Value: !GetAtt StorageStack.Outputs.DynamoDBTableArn
    Export:
      Name: !Sub ${AWS::StackName}-DDB-Table-ARN

  # Lambda Outputs
  LambdaQueryURL:
    Description: URL pública de la función Lambda Query
    Value: !GetAtt LambdaStack.Outputs.LambdaQueryURL
    Export:
      Name: !Sub ${AWS::StackName}-Query-URL

  LambdaETLURL:
    Description: URL pública de la función Lambda ETL
    Value: !GetAtt LambdaStack.Outputs.LambdaETLURL
    Export:
      Name: !Sub ${AWS::StackName}-ETL-URL

  LambdaETLFunctionName:
    Description: Nombre de la función Lambda ETL
    Value: !GetAtt LambdaStack.Outputs.LambdaETLFunctionName
    Export:
      Name: !Sub ${AWS::StackName}-ETL-Function

  LambdaQueryFunctionName:
    Description: Nombre de la función Lambda Query
    Value: !GetAtt LambdaStack.Outputs.LambdaQueryFunctionName
    Export:
      Name: !Sub ${AWS::StackName}-Query-Function

  # WebApp Outputs
  WebAppInstanceId:
    Description: ID de la instancia EC2
    Value: !GetAtt WebAppStack.Outputs.WebAppInstanceId
    Export:
      Name: !Sub ${AWS::StackName}-WebApp-Instance-ID

  WebAppPublicIP:
    Description: IP pública de la instancia EC2
    Value: !GetAtt WebAppStack.Outputs.WebAppPublicIP
    Export:
      Name: !Sub ${AWS::StackName}-WebApp-Public-IP

  WebAppURL:
    Description: URL de la aplicación web
    Value: !GetAtt WebAppStack.Outputs.WebAppURL
    Export:
      Name: !Sub ${AWS::StackName}-WebApp-URL

  APIURL:
    Description: URL de la API
    Value: !GetAtt WebAppStack.Outputs.APIURL
    Export:
      Name: !Sub ${AWS::StackName}-API-URL

  LambdaETLFunctionArn:
    Description: ARN de la función Lambda ETL
    Value: !GetAtt LambdaStack.Outputs.LambdaETLFunctionArn
    Export:
      Name: !Sub ${AWS::StackName}-ETL-Function-ARN

  LambdaQueryFunctionArn:
    Description: ARN de la función Lambda Query
    Value: !GetAtt LambdaStack.Outputs.LambdaQueryFunctionArn
    Export:
      Name: !Sub ${AWS::StackName}-Query-Function-ARN

  # Stack Information
  StackInfo:
    Description: Información del stack desplegado
    Value: !Sub |
      Stack: ${AWS::StackName}
      Region: ${AWS::Region}
      Account: ${AWS::AccountId}
      Network Stack: ${NetworkStack}
      Storage Stack: ${StorageStack}
      Lambda Stack: ${LambdaStack}
      WebApp Stack: ${WebAppStack}
    Export:
      Name: !Sub ${AWS::StackName}-Info 
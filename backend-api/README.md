# Backend API - OrquestaciÃ³n de Servicios

## PropÃ³sito

Este mÃ³dulo implementa una API REST que actÃºa como orquestador entre el frontend y los servicios serverless. Proporciona endpoints para generar URLs prefirmadas de S3, invocar consultas SQL y gestionar la comunicaciÃ³n segura entre componentes.

## Arquitectura

```
Frontend â†’ Backend API â†’ AWS Services (S3, Lambda, DynamoDB)
```

## Funcionalidades Principales

### ðŸ”— OrquestaciÃ³n de Servicios
- GeneraciÃ³n de URLs prefirmadas para carga de archivos
- Proxy para consultas SQL a Lambda Query
- GestiÃ³n de autenticaciÃ³n y autorizaciÃ³n
- ValidaciÃ³n centralizada de requests

### ðŸ”’ Seguridad
- ValidaciÃ³n de entrada con Joi/Zod
- SanitizaciÃ³n de datos
- Control de CORS
- Rate limiting
- Logging de auditorÃ­a

### ðŸ“Š GestiÃ³n de Datos
- ValidaciÃ³n de esquemas de archivos
- TransformaciÃ³n de respuestas
- Manejo de errores centralizado
- MÃ©tricas de rendimiento

## Estructura del Proyecto

```
backend-api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js              # Punto de entrada principal
â”‚   â”œâ”€â”€ app.js                # ConfiguraciÃ³n de Express
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ upload.js         # Rutas para carga de archivos
â”‚   â”‚   â”œâ”€â”€ query.js          # Rutas para consultas SQL
â”‚   â”‚   â””â”€â”€ datasets.js       # Rutas para gestiÃ³n de datasets
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ uploadController.js # Controlador de carga
â”‚   â”‚   â”œâ”€â”€ queryController.js  # Controlador de consultas
â”‚   â”‚   â””â”€â”€ datasetController.js # Controlador de datasets
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ s3Service.js      # Servicio de S3
â”‚   â”‚   â”œâ”€â”€ lambdaService.js  # Servicio de Lambda
â”‚   â”‚   â””â”€â”€ dynamodbService.js # Servicio de DynamoDB
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ auth.js           # Middleware de autenticaciÃ³n
â”‚   â”‚   â”œâ”€â”€ validation.js     # Middleware de validaciÃ³n
â”‚   â”‚   â”œâ”€â”€ errorHandler.js   # Manejo de errores
â”‚   â”‚   â””â”€â”€ cors.js           # ConfiguraciÃ³n CORS
â”‚   â”œâ”€â”€ validators/
â”‚   â”‚   â”œâ”€â”€ uploadValidators.js # Validadores de carga
â”‚   â”‚   â””â”€â”€ queryValidators.js  # Validadores de consultas
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ config.js         # ConfiguraciÃ³n
â”‚       â””â”€â”€ helpers.js        # Utilidades
â”œâ”€â”€ package.json
â”œâ”€â”€ serverless.yml           # ConfiguraciÃ³n serverless (opcional)
â””â”€â”€ tests/
    â”œâ”€â”€ unit/
    â””â”€â”€ integration/
```

## ConfiguraciÃ³n

### Variables de Entorno

```bash
# ConfiguraciÃ³n del servidor
PORT=3000
NODE_ENV=development

# ConfiguraciÃ³n de AWS
AWS_REGION=us-east-1
AWS_PROFILE=default

# Servicios AWS
S3_BUCKET_RAW=your-raw-bucket-name
LAMBDA_QUERY_URL=https://your-lambda-url.amazonaws.com
DDB_TABLE_NAME=your-datasets-table

# ConfiguraciÃ³n de seguridad
JWT_SECRET=your-jwt-secret
CORS_ORIGIN=http://localhost:3000
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# ConfiguraciÃ³n de archivos
MAX_FILE_SIZE_MB=100
ALLOWED_FILE_TYPES=text/csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
```

### ConfiguraciÃ³n de CORS

```javascript
// ConfiguraciÃ³n CORS para desarrollo y producciÃ³n
const corsOptions = {
  origin: process.env.CORS_ORIGIN || 'http://localhost:3000',
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: [
    'Content-Type',
    'Authorization',
    'X-Requested-With',
    'Accept',
    'Origin'
  ]
};
```

## API Endpoints

### Upload Endpoints

#### POST /api/upload/url
Genera una URL prefirmada para carga directa a S3.

**Request:**
```json
{
  "filename": "sales_data_2024.csv",
  "contentType": "text/csv",
  "fileSize": 1048576
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "uploadUrl": "https://s3.amazonaws.com/bucket/...",
    "s3Key": "uploads/uuid-123/sales_data_2024.csv",
    "expiresIn": 3600,
    "fields": {
      "key": "uploads/uuid-123/sales_data_2024.csv",
      "bucket": "raw-bucket",
      "X-Amz-Algorithm": "AWS4-HMAC-SHA256",
      "X-Amz-Credential": "...",
      "X-Amz-Date": "20240115T103000Z",
      "Policy": "...",
      "X-Amz-Signature": "..."
    }
  }
}
```

#### POST /api/upload/validate
Valida un archivo antes de la carga.

**Request:**
```json
{
  "filename": "sales_data_2024.csv",
  "contentType": "text/csv",
  "fileSize": 1048576,
  "schema": {
    "columns": [
      {
        "name": "id",
        "type": "number",
        "required": true
      }
    ]
  }
}
```

### Query Endpoints

#### POST /api/query/execute
Ejecuta una consulta SQL a travÃ©s de Lambda Query.

**Request:**
```json
{
  "sql": "SELECT * FROM 's3://bucket/dataset.parquet' LIMIT 10",
  "datasetIds": ["uuid-123"],
  "parameters": {
    "limit": 100,
    "offset": 0
  }
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "columns": ["id", "name", "value"],
    "rows": [
      [1, "Product A", 100.50],
      [2, "Product B", 200.75]
    ],
    "rowCount": 2,
    "executionTime": 1250,
    "queryHash": "abc123"
  }
}
```

#### GET /api/query/datasets
Lista datasets disponibles para consulta.

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "datasetId": "uuid-123",
      "name": "sales_data_2024",
      "description": "Datos de ventas 2024",
      "rowCount": 10000,
      "columnCount": 5,
      "lastUpdated": "2024-01-15T10:30:00Z"
    }
  ]
}
```

### Dataset Endpoints

#### GET /api/datasets
Lista todos los datasets procesados.

#### GET /api/datasets/:datasetId
Obtiene informaciÃ³n detallada de un dataset.

#### DELETE /api/datasets/:datasetId
Elimina un dataset (opcional).

## Flujo de Procesamiento

### 1. Carga de Archivos
```
Frontend â†’ POST /api/upload/url â†’ ValidaciÃ³n â†’ URL Prefirmada â†’ S3
```

### 2. Consultas SQL
```
Frontend â†’ POST /api/query/execute â†’ ValidaciÃ³n â†’ Lambda Query â†’ S3 Parquet â†’ JSON Response
```

### 3. GestiÃ³n de Datasets
```
Frontend â†’ GET /api/datasets â†’ DynamoDB â†’ Lista de Datasets
```

## ValidaciÃ³n de Entrada

### Esquemas de ValidaciÃ³n

```javascript
// ValidaciÃ³n de carga de archivos
const uploadUrlSchema = Joi.object({
  filename: Joi.string().required().max(255),
  contentType: Joi.string().required().valid('text/csv', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),
  fileSize: Joi.number().required().max(100 * 1024 * 1024) // 100MB
});

// ValidaciÃ³n de consultas SQL
const querySchema = Joi.object({
  sql: Joi.string().required().max(10000),
  datasetIds: Joi.array().items(Joi.string().uuid()).optional(),
  parameters: Joi.object({
    limit: Joi.number().integer().min(1).max(10000).optional(),
    offset: Joi.number().integer().min(0).optional()
  }).optional()
});
```

### SanitizaciÃ³n

```javascript
// SanitizaciÃ³n de consultas SQL
const sanitizeSql = (sql) => {
  // Remover comentarios
  sql = sql.replace(/--.*$/gm, '');
  
  // Validar palabras clave peligrosas
  const dangerousKeywords = ['DROP', 'DELETE', 'TRUNCATE', 'ALTER', 'CREATE'];
  const hasDangerousKeywords = dangerousKeywords.some(keyword => 
    sql.toUpperCase().includes(keyword)
  );
  
  if (hasDangerousKeywords) {
    throw new Error('Consulta SQL contiene palabras clave no permitidas');
  }
  
  return sql.trim();
};
```

## Manejo de Errores

### Middleware de Error

```javascript
const errorHandler = (err, req, res, next) => {
  const { logger } = require('../shared/utils/logger');
  
  logger.error('Error en API', {
    error: err.message,
    stack: err.stack,
    url: req.url,
    method: req.method,
    ip: req.ip
  });

  // Formatear respuesta de error
  const statusCode = err.statusCode || 500;
  const message = err.message || 'Error interno del servidor';
  
  res.status(statusCode).json({
    success: false,
    error: message,
    code: err.code || 'INTERNAL_ERROR',
    timestamp: new Date().toISOString()
  });
};
```

### Tipos de Errores

- **400 Bad Request**: Datos de entrada invÃ¡lidos
- **401 Unauthorized**: Token de autenticaciÃ³n faltante o invÃ¡lido
- **403 Forbidden**: Acceso denegado
- **404 Not Found**: Recurso no encontrado
- **429 Too Many Requests**: Rate limit excedido
- **500 Internal Server Error**: Error interno del servidor

## Seguridad

### AutenticaciÃ³n

```javascript
// Middleware de autenticaciÃ³n (simulado para desarrollo)
const authMiddleware = (req, res, next) => {
  const token = req.headers.authorization?.replace('Bearer ', '');
  
  if (!token) {
    return res.status(401).json({
      success: false,
      error: 'Token de autenticaciÃ³n requerido'
    });
  }
  
  // En producciÃ³n, validar JWT
  try {
    // const decoded = jwt.verify(token, process.env.JWT_SECRET);
    // req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({
      success: false,
      error: 'Token invÃ¡lido'
    });
  }
};
```

### Rate Limiting

```javascript
const rateLimit = require('express-rate-limit');

const apiLimiter = rateLimit({
  windowMs: process.env.RATE_LIMIT_WINDOW_MS || 15 * 60 * 1000, // 15 minutos
  max: process.env.RATE_LIMIT_MAX_REQUESTS || 100, // mÃ¡ximo 100 requests por ventana
  message: {
    success: false,
    error: 'Demasiadas requests, intente mÃ¡s tarde'
  }
});
```

## MonitorizaciÃ³n

### Logging

```javascript
// Middleware de logging
const requestLogger = (req, res, next) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - start;
    
    logger.info('Request procesado', {
      method: req.method,
      url: req.url,
      statusCode: res.statusCode,
      duration,
      ip: req.ip,
      userAgent: req.get('User-Agent')
    });
  });
  
  next();
};
```

### MÃ©tricas

- Tiempo de respuesta promedio
- Tasa de Ã©xito/fallo por endpoint
- NÃºmero de requests por minuto
- Uso de memoria y CPU

## Uso

### Desarrollo Local

```bash
# Instalar dependencias
npm install

# Iniciar servidor de desarrollo
npm run dev

# Ejecutar tests
npm test

# Linting
npm run lint
```

### ProducciÃ³n

```bash
# Build para producciÃ³n
npm run build

# Iniciar servidor de producciÃ³n
npm start

# Con PM2
pm2 start ecosystem.config.js
```

### Docker

```bash
# Construir imagen
docker build -t backend-api .

# Ejecutar contenedor
docker run -p 3000:3000 backend-api
```

## Testing

### Tests Unitarios

```bash
# Ejecutar tests unitarios
npm test

# Con coverage
npm run test:coverage

# Watch mode
npm run test:watch
```

### Tests de IntegraciÃ³n

```bash
# Tests de integraciÃ³n
npm run test:integration

# Tests de API
npm run test:api
```

### Tests de Rendimiento

```bash
# Tests de carga
npm run test:load

# Tests de stress
npm run test:stress
```

## Dependencias

### Principales
- `express` - Framework web
- `aws-sdk` - Cliente AWS
- `joi` - ValidaciÃ³n de esquemas
- `cors` - ConfiguraciÃ³n CORS
- `helmet` - Seguridad HTTP

### Desarrollo
- `nodemon` - Auto-reload
- `jest` - Testing framework
- `supertest` - Testing de API
- `eslint` - Linting de cÃ³digo

## PrÃ³ximos Pasos

1. Implementar autenticaciÃ³n JWT completa
2. Agregar cache con Redis
3. Implementar WebSockets para notificaciones
4. Agregar documentaciÃ³n con Swagger
5. Implementar mÃ©tricas con Prometheus 